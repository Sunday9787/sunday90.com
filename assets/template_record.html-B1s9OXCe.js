import{_ as s,o as a,c as p,a as t,e,f as o}from"./app-DksFnYym.js";const c={};function l(i,n){return a(),p("div",null,[n[0]||(n[0]=t("p",null,"每一段历史记录，都是回忆的窗口，连接着过去与未来...",-1)),e(" more "),n[1]||(n[1]=o(`<h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>撤销、重做、历史记录，听着是有点高大上的样子，单其实本质是是对栈的操作，<code>pop</code> <code>push</code></p><h2 id="需求分析" tabindex="-1"><a class="header-anchor" href="#需求分析" aria-hidden="true">#</a> 需求分析</h2><p>撤销、重做，就是在操作历史记录，所以重点是历史记录如何实现？</p><p>那么很容易</p><p>首先我们需要监听编辑器的所有操作，所以，编辑器需要把这些操作全部都要用事件的形式传递出去消息。注册历史记录监听这些消息从而达到一个记录。撤销重做就是对栈的<code>pop</code> <code>push</code></p><p>类似 <code>PhotoShop</code> 的历史记录那样</p><h2 id="设计" tabindex="-1"><a class="header-anchor" href="#设计" aria-hidden="true">#</a> 设计</h2><p><strong>历史记录</strong></p><p>我们需要设计一套事件，为了更好的维护事件，事件名需要用变量来存储管理。且编辑器的操作事件要跟历史记录事件要区分，也就是说，要做命名空间，这样省事儿简单区分。</p><p><strong>撤销&amp;重做</strong></p><p>我们需要设计一个根据事件类型，来分别实现这个事件的撤销和重做动作</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 数据结构</span>
<span class="token keyword">type</span> <span class="token class-name">RecordActionHandle</span> <span class="token operator">=</span> Record<span class="token operator">&lt;</span>
  <span class="token string">&quot;componentAdd&quot;</span><span class="token operator">|</span><span class="token string">&quot;componentDel&quot;</span><span class="token punctuation">,</span>
  Record<span class="token operator">&lt;</span><span class="token string">&quot;undo&quot;</span><span class="token operator">|</span><span class="token string">&quot;restore&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="事件" tabindex="-1"><a class="header-anchor" href="#事件" aria-hidden="true">#</a> 事件</h2><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> readonly <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">namespace</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">event</span>
 */</span>
<span class="token keyword">function</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token parameter">namespace<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> namespace <span class="token operator">+</span> <span class="token string">&#39;:&#39;</span> <span class="token operator">+</span> event
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> storeSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&#39;store&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> templateChannel <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">editorToHtml</span><span class="token operator">:</span> <span class="token string">&#39;template:to:html&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 缩放变化 */</span>
  <span class="token literal-property property">stageScaleChange</span><span class="token operator">:</span> <span class="token string">&#39;template:scale:change&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 大小变化 */</span>
  <span class="token literal-property property">stageSizeChange</span><span class="token operator">:</span> <span class="token string">&#39;template:size:change&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 边距变化 */</span>
  <span class="token literal-property property">stagePaddingChange</span><span class="token operator">:</span> <span class="token string">&#39;template:padding:change&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 清除 */</span>
  <span class="token literal-property property">stageClear</span><span class="token operator">:</span> <span class="token string">&#39;template:clear&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 撤销 */</span>
  <span class="token literal-property property">stageUndo</span><span class="token operator">:</span> <span class="token string">&#39;template:undo&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 重做 */</span>
  <span class="token literal-property property">stageRestore</span><span class="token operator">:</span> <span class="token string">&#39;template:restore&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 移动 */</span>
  <span class="token literal-property property">stageMove</span><span class="token operator">:</span> <span class="token string">&#39;template:move&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组 组合 */</span>
  <span class="token literal-property property">groupPack</span><span class="token operator">:</span> <span class="token string">&#39;group:pack&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组 解散 */</span>
  <span class="token literal-property property">groupUn</span><span class="token operator">:</span> <span class="token string">&#39;group:un&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 添加 */</span>
  <span class="token literal-property property">componentAdd</span><span class="token operator">:</span> <span class="token string">&#39;component:add&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 删除 */</span>
  <span class="token literal-property property">componentDel</span><span class="token operator">:</span> <span class="token string">&#39;component:del&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 选择 */</span>
  <span class="token literal-property property">componentSelect</span><span class="token operator">:</span> <span class="token string">&#39;component:select&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 取消选择 */</span>
  <span class="token literal-property property">componentSelectUn</span><span class="token operator">:</span> <span class="token string">&#39;component:select:un&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 定位变化开始 */</span>
  <span class="token literal-property property">componentMoveStart</span><span class="token operator">:</span> <span class="token string">&#39;component:move:start&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 定位变化 */</span>
  <span class="token literal-property property">componentMove</span><span class="token operator">:</span> <span class="token string">&#39;component:move&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 定位变化结束 */</span>
  <span class="token literal-property property">componentMoveEnd</span><span class="token operator">:</span> <span class="token string">&#39;component:move:end&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 字体变化 */</span>
  <span class="token literal-property property">componentFontChange</span><span class="token operator">:</span> <span class="token string">&#39;component:font:change&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 字体大小变化 */</span>
  <span class="token literal-property property">componentFontSizeChange</span><span class="token operator">:</span> <span class="token string">&#39;component:font:size:change&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 大小变化开始 */</span>
  <span class="token literal-property property">componentResizeStart</span><span class="token operator">:</span> <span class="token string">&#39;component:resize:start&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 大小变化 */</span>
  <span class="token literal-property property">componentResize</span><span class="token operator">:</span> <span class="token string">&#39;component:resize&#39;</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 大小变化结束 */</span>
  <span class="token literal-property property">componentResizeEnd</span><span class="token operator">:</span> <span class="token string">&#39;component:resize:end&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> recordChannel <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token doc-comment comment">/** 画布 缩放变化 */</span>
  <span class="token literal-property property">stageScaleChange</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>stageScaleChange<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 大小变化 */</span>
  <span class="token literal-property property">stageSizeChange</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>stageSizeChange<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 边距变化 */</span>
  <span class="token literal-property property">stagePaddingChange</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>stagePaddingChange<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 边距变化 */</span>
  <span class="token literal-property property">stageClear</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>stageClear<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 撤销 */</span>
  <span class="token literal-property property">stageUndo</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>stageUndo<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 重做 */</span>
  <span class="token literal-property property">stageRestore</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>stageRestore<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 画布 移动 */</span>
  <span class="token literal-property property">stageMove</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>stageMove<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组 组合 */</span>
  <span class="token literal-property property">groupPack</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>groupPack<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组 解散 */</span>
  <span class="token literal-property property">groupUn</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>groupUn<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 添加 */</span>
  <span class="token literal-property property">componentAdd</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 删除 */</span>
  <span class="token literal-property property">componentDel</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 选择 */</span>
  <span class="token literal-property property">componentSelect</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentSelect<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 取消选择 */</span>
  <span class="token literal-property property">componentSelectUn</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentSelectUn<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 定位变化开始 */</span>
  <span class="token literal-property property">componentMoveStart</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentMoveStart<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 定位变化 */</span>
  <span class="token literal-property property">componentMove</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentMove<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 定位变化结束 */</span>
  <span class="token literal-property property">componentMoveEnd</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentMoveEnd<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 字体变化 */</span>
  <span class="token literal-property property">componentFontChange</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentFontChange<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 字体变化 */</span>
  <span class="token literal-property property">componentFontSizeChange</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentFontSizeChange<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 大小变化开始 */</span>
  <span class="token literal-property property">componentResizeStart</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentResizeStart<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 大小变化 */</span>
  <span class="token literal-property property">componentResize</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentResize<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token doc-comment comment">/** 组件 大小变化结束 */</span>
  <span class="token literal-property property">componentResizeEnd</span><span class="token operator">:</span> <span class="token function">nameSpace</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">,</span> templateChannel<span class="token punctuation">.</span>componentResizeEnd<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>Readonly<span class="token punctuation">&lt;</span>Record<span class="token punctuation">&lt;</span>Template<span class="token punctuation">.</span>BuiltinComponentType<span class="token punctuation">,</span> string<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">}</span></span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> recordTypeMap <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>stageScaleChange<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;画布 缩放变化&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>stageSizeChange<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;画布 大小变化&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>stagePaddingChange<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;画布 边距变化&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>stageMove<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;画布 移动&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>stageClear<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;画布 清空&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>groupPack<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组 组合&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>groupUn<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组 解散&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 添加&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 删除&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentSelect<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 选择&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentSelectUn<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 取消选择&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentMoveStart<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 定位变化开始&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentMove<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 定位变化&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentMoveEnd<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 定位变化结束&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentFontChange<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 字体变化&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentFontSizeChange<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 字体大小变化&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentResizeStart<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 大小变化开始&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentResize<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 大小变化&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>templateChannel<span class="token punctuation">.</span>componentResizeEnd<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;组件 大小变化结束&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NameSpace</strong> 很简单，加个前缀不就好了</p><h2 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h2><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">&#39;moment&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> onBeforeUnmount<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> recordChannel<span class="token punctuation">,</span> recordTypeMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/views/template/constant&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRecord <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/views/template/utils/record&#39;</span>
<span class="token keyword">import</span> eventBus <span class="token keyword">from</span> <span class="token string">&#39;@/utils/eventBus&#39;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecordType<span class="token punctuation">}</span></span> <span class="token parameter">type</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponent<span class="token punctuation">}</span></span> <span class="token parameter">component</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>boolean<span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">record</span><span class="token punctuation">]</span></span> 是否记录
 */</span>
<span class="token keyword">function</span> <span class="token function">recordHandle</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> component <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> record <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> recordData <span class="token operator">=</span> <span class="token function">createRecord</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> component<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;事件&#39;</span><span class="token punctuation">,</span> recordTypeMap<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;组件id&#39;</span><span class="token punctuation">,</span> component<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;组件uid&#39;</span><span class="token punctuation">,</span> component<span class="token punctuation">.</span>uid<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;组件props&#39;</span><span class="token punctuation">,</span> component<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;时间戳&#39;</span><span class="token punctuation">,</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&#39;yyyy-MM-DD HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">groupEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>record<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>record<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordData<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;record&#39;</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;事件&#39;</span><span class="token punctuation">,</span> recordTypeMap<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;时间戳&#39;</span><span class="token punctuation">,</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&#39;yyyy-MM-DD HH:mm:ss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">groupEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span> <span class="token parameter">store</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRecord</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> move <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">let</span> resize <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token doc-comment comment">/**
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Event<span class="token punctuation">&lt;</span>Template<span class="token punctuation">.</span>BuiltinComponent <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">&gt;</span><span class="token punctuation">}</span></span> <span class="token parameter">e</span>
   */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">componentChange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:add&#39;</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:del&#39;</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:font:change&#39;</span><span class="token operator">:</span>
        <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:resize:start&#39;</span><span class="token operator">:</span>
        resize <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:resize&#39;</span><span class="token operator">:</span>
        <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:resize:end&#39;</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">&#39;property&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          resize <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:move:start&#39;</span><span class="token operator">:</span>
        <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:move&#39;</span><span class="token operator">:</span>
        move <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;component:move:end&#39;</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target <span class="token operator">===</span> <span class="token string">&#39;property&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>move<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          move <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentMoveStart<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentMove<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentMoveEnd<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentFontChange<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentResizeStart<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentResize<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentResizeEnd<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">onBeforeUnmount</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentMoveStart<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentMove<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentMoveEnd<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentFontChange<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentSizeChange<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentResizeStart<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentResize<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
    eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>recordChannel<span class="token punctuation">.</span>componentResizeEnd<span class="token punctuation">,</span> componentChange<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为历史记录不涉及到视图层的东西，所以写个hooks即可，首先注册这些历史记录事件，编辑器操作后触发该事件。</p><p><strong>这里要说明一下 <code>componentChange</code> 的参数是 <code>TemplateEvent</code> 这是自定义的事件对象，为什么要这样做</strong></p><blockquote><p>因为需要规范化事件对象，去传递我们需要的参数</p></blockquote><p><strong>为什么不采用 <code>Event</code> 呢？</strong></p><blockquote><p>因为Event有很多属性是用不上的，编辑器触发的也不是传统dom事件</p></blockquote><p>函数 <strong>componentChange</strong></p><p>主要是过滤和处理一些事件压入历史记录栈，但是，有些事件是不必要全部记录。例如移动事件，这个当拖动控件时会一直触发，我们只需要记录 <code>component:move:end</code> 事件即可，得到最终移动的位置。</p><p>函数 <strong>recordHandle</strong></p><p>在这个函数里，才真正的开始往历史记录栈里压入数据，当然可以做最大历史记录限制。</p><h2 id="撤销-重做" tabindex="-1"><a class="header-anchor" href="#撤销-重做" aria-hidden="true">#</a> 撤销&amp;重做</h2><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> recordActionHandle <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">componentAdd</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">}</span></span> <span class="token parameter">record</span>
     */</span>
    <span class="token function">undo</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>restore<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>

      eventBus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span>
        templateChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">TemplateEvent</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">detail</span><span class="token operator">:</span> record<span class="token punctuation">.</span>component<span class="token punctuation">,</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&#39;stage&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">}</span></span> <span class="token parameter">record</span>
     */</span>
    <span class="token function">restore</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventBus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span>
        templateChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">TemplateEvent</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">detail</span><span class="token operator">:</span> record<span class="token punctuation">.</span>component<span class="token punctuation">,</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&#39;stage&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentDel</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">}</span></span> <span class="token parameter">record</span>
     */</span>
    <span class="token function">undo</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>restore<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>

      eventBus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span>
        templateChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">TemplateEvent</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>componentAdd<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">detail</span><span class="token operator">:</span> record<span class="token punctuation">.</span>component<span class="token punctuation">,</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&#39;stage&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">}</span></span> <span class="token parameter">record</span>
     */</span>
    <span class="token function">restore</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventBus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span>
        templateChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">TemplateEvent</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>componentDel<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">detail</span><span class="token operator">:</span> record<span class="token punctuation">.</span>component<span class="token punctuation">,</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&#39;stage&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentGeneral</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">}</span></span> <span class="token parameter">record</span>
     */</span>
    <span class="token function">undo</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">undoGeneral</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>record<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">}</span></span> <span class="token parameter">record</span>
     */</span>
    <span class="token function">restore</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">restoreGeneral</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>record<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>撤销和重做分为2种类型</strong></p><ol><li><p>常规类型</p></li><li><p>非常规类型</p></li></ol><p><strong>为什么这样讲？</strong></p><blockquote><p>控件的添加和删除是一个比较特殊的操作，会涉及到控件的初始化销毁，而普通的，像位置调整、各种属性的调整、这些是不影响控件的声明周期，所以称之为普通操作。</p></blockquote><p>上述代码可以看到，具体实现也不是说直接在这里写具体的撤销和重写，因为完全没必要，因为本身这些创建和删除等等操作都有一个事件来通知完成。所以，只需要反着触发事件即可（默认所有编辑器的事件都会被log日志打印出来，但是操作历史记录不需要log，所以<code>emit</code>的第二个参数是<code>false</code>）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@this</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>Store<span class="token punctuation">}</span></span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token string">&#39;undo&#39;</span><span class="token operator">|</span><span class="token string">&#39;restore&#39;</span><span class="token punctuation">}</span></span> <span class="token parameter">action</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Template<span class="token punctuation">.</span>BuiltinComponentRecord<span class="token punctuation">}</span></span> <span class="token parameter">record</span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">recordHandle</span><span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&#39;component:add&#39;</span><span class="token operator">:</span>
      recordActionHandle<span class="token punctuation">.</span>componentAdd<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>record<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">&#39;component:del&#39;</span><span class="token operator">:</span>
      recordActionHandle<span class="token punctuation">.</span>componentDel<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>record<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">&#39;component:move:end&#39;</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">&#39;component:resize:end&#39;</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">&#39;component:font:change&#39;</span><span class="token operator">:</span>
      recordActionHandle<span class="token punctuation">.</span>componentGeneral<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>record<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编辑器监听undo 和 restore 事件，调用此方法</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// /template/index.vue</span>

<span class="token doc-comment comment">/**
 * 撤销
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">stageUndo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> popRecord <span class="token operator">=</span> store<span class="token punctuation">.</span>record<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>popRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;undo&#39;</span><span class="token punctuation">,</span> popRecord<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 重做
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">stageRestore</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> popRecord <span class="token operator">=</span> store<span class="token punctuation">.</span>restore<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>popRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recordHandle</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;restore&#39;</span><span class="token punctuation">,</span> popRecord<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>stageUndo<span class="token punctuation">,</span> stageUndo<span class="token punctuation">)</span>
  eventBus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>stageRestore<span class="token punctuation">,</span> stageRestore<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">onUnmounted</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>stageUndo<span class="token punctuation">,</span> stageUndo<span class="token punctuation">)</span>
  eventBus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>templateChannel<span class="token punctuation">.</span>stageRestore<span class="token punctuation">,</span> stageRestore<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编辑器撤销时需要判断一下是否还有历史记录存在</p><p>在这里我并没有使用一个队列来存放历史记录，可能我当时想错了，正常来讲是维护一个队列即可。</p><p><em>感慨一句</em></p><p><em>Vue3把事件移除还有不在支持监听组件的原生事件（必须手动声明emit），不再支持过滤器，真不适应，当然我也相信这些改动也是经过深思熟虑的。</em></p><h2 id="最后" tabindex="-1"><a class="header-anchor" href="#最后" aria-hidden="true">#</a> 最后</h2><p>希望我的设计能给你带来一点点的启发，如果有，请不要忘了点赞转发留言哦</p><figure><img src="https://static-1256180570.cos.ap-nanjing.myqcloud.com/image/1731947600.jpg" alt="请问小姐你的心怎么走" tabindex="0" loading="lazy"><figcaption>请问小姐你的心怎么走</figcaption></figure>`,44))])}const r=s(c,[["render",l],["__file","template_record.html.vue"]]);export{r as default};
